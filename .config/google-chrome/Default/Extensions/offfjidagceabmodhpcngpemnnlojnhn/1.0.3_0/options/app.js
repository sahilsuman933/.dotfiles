var app=angular.module("siteBlocker",[]);app.controller("MainController",["$scope","$filter","$interval","$timeout","HelperService","$http",function(e,t,o,s,a,r){!function(){var s=chrome.runtime.getManifest();e.appVersion=s.version,e.siteList=[],e.errorSite=!1,e.newSite="",e.removedSite="",e.unblockedSite="",e.showPassInput=a.getPass(),e.checkbox={},e.sortReverse=!1,e.not={list:[],show:!1,read:[],unRead:0},e.checkbox.optionCloseTabs=parseInt(a.getKey("close_option")),n(),e.regex=!1,e.errorMessages={maxTags:"Max tags count error",patternError:"Invalid tag",duplicateTag:"Tag is already exists"};for(var i=[],l=0;l<24;l++)for(var c=0;c<60;c+=10){var d=l<10?"0"+l:l,g=c<10?"0"+c:c;i.push(d+":"+g)}function f(){var o=new Date;e.now=t("date")(o,"HH:mm:ss")}e.timeRange=i,f(),o(f,1e3),e.minTime=0,e.maxTime=24;a.getKey("hour_config",!0,{});e.hour_config_extra=a.getExtraHour(),e.addExtraTime=function(){e.hour_config_extra.push({start:"18:00",end:"21:00"})},e.removeHourItem=function(t){e.hour_config_extra.splice(t,1)},e.redirect_url=localStorage.getItem("redirect_url"),e.currentPage="dashboard";var p=document.location.hash.substring(1);chrome.runtime.sendMessage({method:"getStatus"},(function(t){e.siteList=t.status?JSON.parse(t.status):[],-1!=e.siteList.indexOf(p)&&($("#passwordModal").modal(),u("#user_password",1e3),e.removedSite=p),e.$apply()}));var h=localStorage.getItem("lastUpdate")||0;+new Date-h>864e5?(m="https://site-blocker.info/site/notifications",r.get(m).then((function(t){t.data&&(e.not.list=t.data||[],localStorage.setItem("notifications",JSON.stringify(e.not.list)),localStorage.setItem("lastUpdate",+new Date),e.not=a.getReadMessages(e.not))}))):(e.not.list=a.getKey("notifications",!0,[])||[],e.not=a.getReadMessages(e.not));var m}();const i="http://site-blocker.info/api/";function n(){e.checkbox.subdomainOption=parseInt(a.getKey("subdomainOption")),e.checkbox.iframeOption=parseInt(a.getKey("iframeOption")),e.checkbox.blockKeyOption=parseInt(a.getKey("blockKeyOption")),e.checkbox.whiteList=1===parseInt(a.getKey("whiteList")),e.blockPattern=localStorage.getItem("blockPattern")||"",e.blockPatternFlag=localStorage.getItem("blockPatternFlag")||"";var t=[];(JSON.parse(a.getKey("blockKeyList"))||[]).forEach((function(e){t.push({key:e})})),e.tagList=t}function l(){var t=JSON.stringify(e.siteList);chrome.runtime.sendMessage({method:"save_data",value:t},(function(e){1==parseInt(e.status)?$.notify("Changes saved !",{globalPosition:"top right",className:"success"}):alert("Error to saving data")}))}function c(){localStorage.setItem("pass",a.md5(e.userPassword)),e.showPassInput=a.getPass(),e.userPassword="",alert("Password saved!")}function d(){e.hourSaved=!0,s((function(){e.hourSaved=!1}),1500),e.checkbox.optionHour?(localStorage.setItem("hour_option",1),localStorage.setItem("hour_config_extra",JSON.stringify(e.hour_config_extra))):localStorage.setItem("hour_option",0),e.hourPasswordModel=""}function u(e,t){s((function(){$(e).focus()}),t)}function g(){var t=e.checkbox.subdomainOption?1:0,o=e.checkbox.iframeOption?1:0,s=e.checkbox.blockKeyOption?1:0,a=e.checkbox.optionCloseTabs?1:0,r=e.checkbox.whiteList?1:0,i=[];if(s){if(i=e.tagList.reduce((function(e,t){return e.push(t.key),e}),[]),e.blockPattern)try{e.blockPatternFlag?new RegExp(e.blockPattern,e.blockPatternFlag).test("text"):new RegExp(e.blockPattern).test("text")}catch(e){return void alert(e.message)}}else e.blockPattern="",e.blockPatternFlag="";localStorage.setItem("blockKeyList",JSON.stringify(i)),localStorage.setItem("subdomainOption",t),localStorage.setItem("iframeOption",o),localStorage.setItem("blockKeyOption",s),localStorage.setItem("close_option",a),localStorage.setItem("whiteList",r),localStorage.setItem("blockPattern",e.blockPattern),e.blockPatternFlag=e.blockPattern?e.blockPatternFlag:"",localStorage.setItem("blockPatternFlag",e.blockPatternFlag),$.notify("Changes Saved !",{globalPosition:"top right",className:"success"}),e.extraConfigPasswordModel=""}function f(){e.synchModalPassword="",e.keyInput=""}document.addEventListener("click",(function(t){t.target.closest(".notification-li")||(e.not.show=!1)})),e.sortList=function(){e.sortReverse=!e.sortReverse},e.openLink=function(){location.href="https://site-blocker.info"},e.addSite=function(){var t;if(e.newSite=e.newSite.trim(),e.newSite)if(a.isUrl(e.newSite)){var o=a.getHost(e.newSite);-1==e.siteList.indexOf(o)?(t=a.getHost(e.newSite),e.siteList.push(t),e.newSite="",e.errorSite=!1):(alert("Site already exists in blocked list"),u("#custom_site",100))}else e.errorSite=!0;else $("#custom_site").focus()},e.removeSite=function(t){var o=a.findIndex(e.siteList,t);-1!=o&&e.siteList.splice(o,1)},e.optionTabsCallback=function(e){e=e?1:0,localStorage.setItem("close_option",e),$.notify("Changes saved !",{globalPosition:"top right",className:"success"})},e.saveChanges=function(){if(e.sitePassword="",a.getPass())return $("#passwordModal").modal(),void u("#user_password",500);l()},e.saveWithPass=function(){if(e.sitePassword)if(a.md5(e.sitePassword)==a.getPass()){if(e.removedSite){var t=a.findIndex(e.siteList,e.removedSite);-1!=t&&(e.siteList.splice(t,1),e.unblockedSite=e.removedSite,e.removedSite="",e.sitePassword="",location.hash="")}else e.hideModals();l()}else e.sitePassword="",u("#user_password",50),alert("Wrong password");else $("#user_password").focus()},e.hideAlert=function(){e.keyError="",e.infoKey=""},e.hideModals=function(){e.exportSiteList=!1,e.loadSiteList=!1,e.passwordModal=!1,e.hourModal=!1,e.extraConfig=!1,e.synchronizeModal=!1,e.resetPasswordModal=!1,e.hideAlert()},e.showExportModal=function(){e.exportSiteList=!0;var t=e.siteList.join("\n");e.exportDataModel=t},e.showLoadModal=function(){e.loadSiteList=!0,e.loadDataListModel="",e.loadDataResult=[]},e.showHourModal=function(){e.hourModal=!0,e.hourPasswordModel="",e.checkbox.optionHour=parseInt(a.getKey("hour_option")),e.hourSaved=!1,e.hour_config_extra=a.getExtraHour()},e.showExtraConfigModal=function(){n(),e.currentPage="extra_config",e.extraConfigPasswordModel=""},e.loadSiteDataList=function(){e.loadDataListModel=e.loadDataListModel.trim(),e.loadDataResult=[],0!=e.loadDataListModel.length?(e.loadDataArray=e.loadDataListModel.split(/\n/),e.loadDataArray.forEach((function(t){t=t.trim();var o={className:"",site:t=a.getHost(t)};if(!a.isUrl(t))return o.message=" is not valid site",o.className="not-valid",void e.loadDataResult.push(o);-1==e.siteList.indexOf(t)?(o.message=" added to list",o.className="added",e.siteList.push(t)):(o.className="exists",o.message=" already exists in blocked list"),e.loadDataResult.push(o)}))):$("#site_list").focus()},e.setPassword=function(){if($("#password").focus(),e.userPassword)if(a.getPass()){var t=prompt("Enter old password");if(!t)return;if(a.md5(t)!=a.getPass())return void alert("Wrong password");c()}else c()},e.removePassword=function(){if(a.getPass()){var t=prompt("Enter current password");t&&(a.md5(t)==a.getPass()?(localStorage.removeItem("pass"),e.showPassInput=a.getPass(),alert("Password removed !")):alert("Wrong Password"))}},e.saveHourChanges=function(){e.hourSaved=!1;var t=a.getPass();if(t){if(!e.hourPasswordModel)return void u("#hour-modal-password",100);if(a.md5(e.hourPasswordModel)!=t)return e.hourPasswordModel="",alert("Wrong password"),void u("#hour-modal-password",100);d()}else d()},e.saveExtraConfig=function(){var t=a.getPass();if(t){if(!e.extraConfigPasswordModel)return void u("#extraConfigPassword",100);a.md5(e.extraConfigPasswordModel)!==t?(e.extraConfigPasswordModel="",alert("Wrong password"),u("#extraConfigPassword",100)):g()}else g()},e.synchronizeSaveToDb=function(){if(!e.keyInput)return e.keyError="Enter key",void u("#key_input",100);if(e.showPassInput&&a.md5(e.synchModalPassword)!=a.getPass())return e.keyError="Password is incorrect",void u("#synch-modal-password",100);var t={key:e.keyInput,sites:e.siteList},o=!0;e.siteList.length>0&&(o=confirm("Do you want to save "+e.siteList.length+" site ?")),o&&r.post("http://site-blocker.info/api/save-data/",t,{headers:{"Content-Data-Type":"json"}}).then((function(t){"true"==t.data.success||1==t.data.success?(e.keyError="",e.infoKey="Your data saved!",f()):e.keyError=t.data.message}),(function(t){e.keyError="Unable to handle request, try later"}))},e.synchronizeLoadFromExternal=function(){if(!e.keyInput)return e.keyError="Enter key",void u("#key_input",100);if(e.showPassInput&&a.md5(e.synchModalPassword)!=a.getPass())return e.keyError="Password is incorrect",void u("#synch-modal-password",100);if(confirm("Do you want to load sites fron external? \nYour current list will be overwritten ")){var t=i+"get/"+e.keyInput;r.get(t).then((function(t){"true"==t.data.success||1==t.data.success?(e.siteList=t.data.sites||[],e.keyError="",e.infoKey="Loaded "+e.siteList.length+" site from external. Not forget to save",f()):e.keyError=t.data.message}),(function(t){e.keyError="Unable to handle request. Try later"}))}},e.showSynchronizeModal=function(){e.synchronizeModal=!0,e.keyInput="",e.keyError="",e.infoKey=""},e.showSetPasswordModal=function(){e.userPassword="",a.getPass()},e.clearList=function(){confirm("Clear blockes list ?")&&(e.siteList=[])},e.saveRedirectUrl=function(){a.isUrl(e.redirect_url)||!e.redirect_url?(e.redirect_url&&!e.redirect_url.includes("://")&&(e.redirect_url="http://"+e.redirect_url),chrome.runtime.sendMessage({method:"update_redirect_url",value:e.redirect_url},(function(e){1==parseInt(e.status)?$.notify("Changes saved !",{globalPosition:"top right",className:"success"}):alert("Error to saving data")}))):(alert("Invalid Url"),u("#redirect_url",100))},e.copyText=function(){document.getElementById("exportTxt").select(),document.execCommand("copy"),$("#copyText").text("Copied !"),setTimeout((function(){$("#copyText").text("Copy")}),800)},e.setRead=function(t){e.not.read.includes(t)||(e.not.read.push(t),localStorage.setItem("read",JSON.stringify(e.not.read)),e.not=a.getReadMessages(e.not))}}]);